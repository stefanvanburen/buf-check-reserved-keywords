name: ci
on: push
permissions:
  contents: read
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - run: go test -race ./...
  publish:
    if: ${{ github.ref == 'refs/heads/main' }}
    needs:
      - ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: bufbuild/buf-action@v1
        with:
          setup_only: true
          token: ${{ secrets.BUF_TOKEN }}
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - run: |
          GOOS=wasip1 GOARCH=wasm go build -o buf-check-reserved-keywords.wasm .
          buf plugin push buf.build/svanburenorg/reserved-keywords \
              --binary=buf-check-reserved-keywords.wasm \
              --source-control-url=https://github.com/${{github.repository}}/commit/${{github.sha}}
